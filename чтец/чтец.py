import sys
import subprocess
import os
from importlib import util
import tkinter as tk
from tkinter import filedialog, messagebox, scrolledtext

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
def check_and_install_libraries():
    REQUIRED_LIBRARIES = [
        ('chardet', 'chardet'),
        # –î–ª—è pyinstaller –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
        # ('pyinstaller', 'pyinstaller')
    ]
    
    missing_libs = []
    for (import_name, pkg_name) in REQUIRED_LIBRARIES:
        if util.find_spec(import_name) is None:
            missing_libs.append(pkg_name)
    
    if missing_libs:
        print(f"–¢—Ä–µ–±—É—é—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: {', '.join(missing_libs)}")
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ pip
            import pip
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            subprocess.check_call([sys.executable, '-m', 'pip', 'install', *missing_libs])
            print("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
            os.execv(sys.executable, ['python'] + sys.argv)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: {e}")
            response = messagebox.askyesno(
                "–û—à–∏–±–∫–∞",
                f"–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏: {', '.join(missing_libs)}\n"
                "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏? (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)"
            )
            if response:
                try:
                    subprocess.check_call([sys.executable, '-m', 'pip', 'install', *missing_libs])
                    os.execv(sys.executable, ['python'] + sys.argv)
                except:
                    messagebox.showerror(
                        "–û—à–∏–±–∫–∞",
                        "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é:\n"
                        f"pip install {' '.join(missing_libs)}"
                    )
                    sys.exit(1)
            else:
                sys.exit(1)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
check_and_install_libraries()

# –¢–µ–ø–µ—Ä—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import chardet

class UltimateWordReader:
    def __init__(self, root):
        self.root = root
        self.language = "ru"
        self.translations = self.load_translations()
        self.init_ui()
        self.update_language()
    
    def load_translations(self):
        return {
            "ru": {
                "title": "–£–ª—É—á—à–µ–Ω–Ω—ã–π —á—Ç–µ—Ü —Ç–µ–∫—Å—Ç–∞",
                "open": "üìÇ –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª",
                "help": "‚ùì –ü–æ–º–æ—â—å",
                "language": "üåê English",
                "speed": "–°–∫–æ—Ä–æ—Å—Ç—å:",
                "start": "‚ñ∂ –°—Ç–∞—Ä—Ç",
                "pause": "‚è∏ –ü–∞—É–∑–∞",
                "prev": "‚óÄ –ù–∞–∑–∞–¥",
                "next": "–í–ø–µ—Ä–µ–¥ ‚ñ∂",
                "file_loaded": "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω",
                "words_loaded": "–ó–∞–≥—Ä—É–∂–µ–Ω–æ {} —Å–ª–æ–≤",
                "error": "–û—à–∏–±–∫–∞",
                "file_error": "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª:\n{}",
                "instructions": self.get_russian_instructions()
            },
            "en": {
                "title": "Enhanced Text Reader",
                "open": "üìÇ Open File",
                "help": "‚ùì Help",
                "language": "üåê –†—É—Å—Å–∫–∏–π",
                "speed": "Speed:",
                "start": "‚ñ∂ Start",
                "pause": "‚è∏ Pause",
                "prev": "‚óÄ Previous",
                "next": "Next ‚ñ∂",
                "file_loaded": "File loaded",
                "words_loaded": "Loaded {} words",
                "error": "Error",
                "file_error": "Failed to load file:\n{}",
                "instructions": self.get_english_instructions()
            }
        }
    
    def get_russian_instructions(self):
        return """–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ:

1. –û–¢–ö–†–´–¢–ò–ï –§–ê–ô–õ–ê
- –ù–∞–∂–º–∏—Ç–µ "üìÇ –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª"
- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª (.txt)

2. –£–ü–†–ê–í–õ–ï–ù–ò–ï
‚ñ∂ "–°—Ç–∞—Ä—Ç/–ü–∞—É–∑–∞" - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —á—Ç–µ–Ω–∏–µ
‚óÄ "–ù–∞–∑–∞–¥" - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–ª–æ–≤–æ
‚ñ∂ "–í–ø–µ—Ä–µ–¥" - —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ

3. –°–ö–û–†–û–°–¢–¨
- –†–µ–≥—É–ª–∏—Ä—É–π—Ç–µ –ø–æ–ª–∑—É–Ω–∫–æ–º (0.5-20)

4. –ü–û–î–°–ö–ê–ó–ö–ò
- F11 - –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
- Esc - –≤—ã—Ö–æ–¥ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞

5. –ï–°–õ–ò –§–ê–ô–õ –ù–ï –û–¢–ö–†–´–í–ê–ï–¢–°–Ø:
- –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –ë–ª–æ–∫–Ω–æ—Ç–µ
- –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ UTF-8
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"""
    
    def get_english_instructions(self):
        return """USER INSTRUCTIONS:

1. OPENING FILES
- Click "üìÇ Open File"
- Select a text file (.txt)

2. CONTROLS
‚ñ∂ "Start/Pause" - auto reading
‚óÄ "Previous" - previous word
‚ñ∂ "Next" - next word

3. SPEED
- Adjust with slider (0.5-20)

4. TIPS
- F11 - fullscreen mode
- Esc - exit fullscreen

5. IF FILE WON'T OPEN:
- Open in Notepad
- Save as UTF-8
- Try again"""
    
    def init_ui(self):
        self.root.geometry("1400x900")
        self.root.configure(bg='#f0f0f0')
        
        # –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å
        self.top_frame = tk.Frame(self.root, bg='#e0e0e0', padx=10, pady=5)
        self.top_frame.pack(fill=tk.X)
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        self.btn_open = tk.Button(self.top_frame, font=('Arial', 12), bg='#4CAF50', fg='white', relief=tk.FLAT)
        self.btn_open.pack(side=tk.LEFT)
        
        self.btn_help = tk.Button(self.top_frame, font=('Arial', 12), bg='#2196F3', fg='white', relief=tk.FLAT)
        self.btn_help.pack(side=tk.LEFT, padx=5)
        
        self.btn_language = tk.Button(self.top_frame, font=('Arial', 12), bg='#FF9800', fg='white', relief=tk.FLAT)
        self.btn_language.pack(side=tk.LEFT, padx=5)
        
        # –ü–æ–ª–∑—É–Ω–æ–∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
        self.speed_frame = tk.Frame(self.top_frame, bg='#e0e0e0')
        self.speed_frame.pack(side=tk.RIGHT)
        
        self.speed_label = tk.Label(self.speed_frame, font=('Arial', 10), bg='#e0e0e0')
        self.speed_label.pack(side=tk.LEFT)
        
        self.speed_scale = tk.Scale(
            self.speed_frame,
            from_=0.5, to=20, resolution=0.5,
            orient=tk.HORIZONTAL,
            font=('Arial', 10),
            bg='#e0e0e0',
            highlightthickness=0,
            length=200
        )
        self.speed_scale.set(5)
        self.speed_scale.pack(side=tk.LEFT)
        
        # –û—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        self.word_label = tk.Label(
            self.root,
            font=('Arial', 82, 'bold'),
            fg='#333333',
            bg='#f0f0f0',
            wraplength=1200,
            pady=100
        )
        self.word_label.pack(expand=True)
        
        # –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        self.bottom_frame = tk.Frame(self.root, bg='#e0e0e0', padx=10, pady=10)
        self.bottom_frame.pack(fill=tk.X, side=tk.BOTTOM)
        
        # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        self.nav_frame = tk.Frame(self.bottom_frame, bg='#e0e0e0')
        self.nav_frame.pack(side=tk.LEFT, expand=True)
        
        self.btn_prev = tk.Button(
            self.nav_frame,
            font=('Arial', 12),
            bg='#2196F3',
            fg='white',
            state=tk.DISABLED,
            width=10
        )
        self.btn_prev.pack(side=tk.LEFT, padx=5)
        
        self.btn_play = tk.Button(
            self.nav_frame,
            font=('Arial', 14, 'bold'),
            bg='#4CAF50',
            fg='white',
            width=10,
            height=1
        )
        self.btn_play.pack(side=tk.LEFT, padx=20)
        
        self.btn_next = tk.Button(
            self.nav_frame,
            font=('Arial', 12),
            bg='#2196F3',
            fg='white',
            state=tk.DISABLED,
            width=10
        )
        self.btn_next.pack(side=tk.LEFT, padx=5)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        self.words = []
        self.current_word = 0
        self.file_path = ""
        self.playing = False
        self.after_id = None
        
        # –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ–º–∞–Ω–¥
        self.btn_open.config(command=self.load_file)
        self.btn_help.config(command=self.show_instructions)
        self.btn_language.config(command=self.toggle_language)
        self.btn_play.config(command=self.toggle_play)
        self.btn_prev.config(command=self.prev_word)
        self.btn_next.config(command=self.next_word)
    
    def toggle_language(self):
        self.language = "en" if self.language == "ru" else "ru"
        self.update_language()
    
    def update_language(self):
        lang = self.translations[self.language]
        self.root.title(lang["title"])
        self.btn_open.config(text=lang["open"])
        self.btn_help.config(text=lang["help"])
        self.btn_language.config(text=lang["language"])
        self.speed_label.config(text=lang["speed"])
        self.btn_play.config(text=lang["pause"] if self.playing else lang["start"])
        self.btn_prev.config(text=lang["prev"])
        self.btn_next.config(text=lang["next"])
    
    def show_instructions(self):
        instr_window = tk.Toplevel(self.root)
        instr_window.title(self.translations[self.language]["help"])
        instr_window.geometry("800x600")
        
        text_area = scrolledtext.ScrolledText(
            instr_window,
            wrap=tk.WORD,
            font=('Arial', 12),
            padx=15,
            pady=15
        )
        text_area.pack(expand=True, fill=tk.BOTH)
        text_area.insert(tk.END, self.translations[self.language]["instructions"])
        text_area.config(state=tk.DISABLED)
        
        btn_close = tk.Button(
            instr_window,
            text="OK" if self.language == "en" else "–ó–∞–∫—Ä—ã—Ç—å",
            command=instr_window.destroy,
            font=('Arial', 12),
            bg='#4CAF50',
            fg='white'
        )
        btn_close.pack(pady=10)
    
    def load_file(self):
        filetypes = [
            (self.translations[self.language]["file_loaded"], "*.txt"),
            ("All files", "*.*")
        ] if self.language == "en" else [
            ("–¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã", "*.txt"),
            ("–í—Å–µ —Ñ–∞–π–ª—ã", "*.*")
        ]
        
        filepath = filedialog.askopenfilename(
            title=self.btn_open["text"],
            filetypes=filetypes
        )
        
        if not filepath:
            return
        
        try:
            with open(filepath, 'rb') as f:
                raw_data = f.read()
            
            result = chardet.detect(raw_data)
            encoding = result['encoding'] if result['confidence'] > 0.7 else 'utf-8'
            content = raw_data.decode(encoding, errors='replace')
            
            self.words = content.split()
            self.current_word = 0
            self.file_path = filepath
            
            self.update_word_display()
            self.btn_prev.config(state=tk.NORMAL)
            self.btn_next.config(state=tk.NORMAL)
            self.btn_play.config(text=self.translations[self.language]["start"])
            
            messagebox.showinfo(
                self.translations[self.language]["file_loaded"],
                self.translations[self.language]["words_loaded"].format(len(self.words))
            )
            
        except Exception as e:
            messagebox.showerror(
                self.translations[self.language]["error"],
                self.translations[self.language]["file_error"].format(str(e))
            )
    
    def update_word_display(self):
        if 0 <= self.current_word < len(self.words):
            self.word_label.config(text=self.words[self.current_word])
        else:
            self.word_label.config(text="---")
    
    def toggle_play(self):
        if not self.words:
            return
            
        self.playing = not self.playing
        lang = self.translations[self.language]
        
        if self.playing:
            self.btn_play.config(text=lang["pause"])
            self.play_next_word()
        else:
            self.btn_play.config(text=lang["start"])
            if self.after_id:
                self.root.after_cancel(self.after_id)
                self.after_id = None
    
    def play_next_word(self):
        if not self.playing:
            return
            
        if self.current_word < len(self.words) - 1:
            self.current_word += 1
            self.update_word_display()
            delay = int(1000 / self.speed_scale.get())
            self.after_id = self.root.after(delay, self.play_next_word)
        else:
            self.playing = False
            self.btn_play.config(text=self.translations[self.language]["start"])
    
    def next_word(self):
        if self.current_word < len(self.words) - 1:
            self.current_word += 1
            self.update_word_display()
            if self.playing:
                self.toggle_play()
    
    def prev_word(self):
        if self.current_word > 0:
            self.current_word -= 1
            self.update_word_display()
            if self.playing:
                self.toggle_play()

if __name__ == "__main__":
    root = tk.Tk()
    app = UltimateWordReader(root)
    root.mainloop()